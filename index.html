<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#2563eb">
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <title>FTTH Planner V9</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <style>
        :root { --primary: #2563eb; --danger: #ef4444; --success: #22c55e; --bg: #f8fafc; --text: #1e293b; }
        body { font-family: -apple-system, sans-serif; background: var(--bg); color: var(--text); padding: 0; margin: 0; padding-bottom: 80px; }
        
        /* HEADER */
        .header { background: var(--primary); color: white; padding: 15px; border-bottom-left-radius: 20px; border-bottom-right-radius: 20px; box-shadow: 0 4px 10px rgba(37,99,235,0.2); }
        .header h2 { margin: 0; font-size: 1.2rem; display: flex; justify-content: space-between; align-items: center; }
        .badge-sfp { background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 20px; font-size: 0.8rem; }

        .container { max-width: 600px; margin: -20px auto 0; padding: 0 15px; display: flex; flex-direction: column; gap: 15px; }

        /* CARDS */
        .card { background: white; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .card-head { font-weight: bold; color: #64748b; font-size: 0.9rem; margin-bottom: 10px; border-bottom: 1px solid #eee; padding-bottom: 5px; display: flex; justify-content: space-between;}

        /* TABLE STYLES */
        .table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; border-radius: 8px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; min-width: 650px; }
        th { background: #f1f5f9; padding: 12px 8px; text-align: left; color: #475569; font-weight: 600; }
        td { padding: 10px 8px; border-bottom: 1px solid #e2e8f0; vertical-align: middle; }
        
        .status-dot { height: 8px; width: 8px; background-color: #bbb; border-radius: 50%; display: inline-block; margin-right: 5px; }
        .dot-green { background-color: var(--success); }
        .dot-red { background-color: var(--danger); }
        .dot-orange { background-color: #f59e0b; }

        /* BUTTONS */
        .btn-icon { border: none; background: #e2e8f0; width: 32px; height: 32px; border-radius: 6px; color: #475569; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; font-size: 1.1rem; }
        .btn-add-child { background: var(--primary); color: white; }
        .btn-del { background: #fee2e2; color: var(--danger); }
        .btn-float { position: fixed; bottom: 20px; right: 20px; background: var(--primary); width: 56px; height: 56px; border-radius: 50%; box-shadow: 0 4px 15px rgba(37,99,235,0.4); color: white; font-size: 28px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 90; border: none; }
        
        /* MODAL (POPUP) */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 100; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(2px); }
        .modal-overlay.active { display: flex; }
        .modal { background: white; width: 100%; max-width: 500px; border-top-left-radius: 20px; border-top-right-radius: 20px; padding: 25px; animation: slideUp 0.3s ease; box-shadow: 0 -4px 20px rgba(0,0,0,0.1); }
        
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }

        /* FORM ELEMENTS */
        .form-group { margin-bottom: 15px; }
        .form-label { display: block; font-size: 0.85rem; color: #64748b; margin-bottom: 5px; font-weight: 500; }
        .form-input, .form-select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-size: 1rem; box-sizing: border-box; background: white; }
        .form-row { display: flex; gap: 10px; }
        
        .btn-block { width: 100%; padding: 14px; border: none; border-radius: 8px; font-weight: bold; font-size: 1rem; cursor: pointer; }
        .btn-save { background: var(--primary); color: white; }
        
        /* TREE */
        .tree-container { overflow-x: auto; padding: 10px; text-align: center; }
        .tree ul { padding-top: 20px; position: relative; display: flex; justify-content: center; }
        .tree li { float: left; text-align: center; list-style-type: none; position: relative; padding: 20px 2px; }
        .tree li::before, .tree li::after { content: ''; position: absolute; top: 0; right: 50%; border-top: 1px solid #ccc; width: 50%; height: 20px; }
        .tree li::after { right: auto; left: 50%; border-left: 1px solid #ccc; }
        .tree li:only-child::after, .tree li:only-child::before { display: none; }
        .tree li:only-child { padding-top: 0; }
        .tree li:first-child::before, .tree li:last-child::after { border: 0 none; }
        .tree li:last-child::before { border-right: 1px solid #ccc; border-radius: 0 5px 0 0; }
        .tree li:first-child::after { border-radius: 5px 0 0 0; }
        .tree ul ul::before { content: ''; position: absolute; top: 0; left: 50%; border-left: 1px solid #ccc; width: 0; height: 20px; }
        
        .node-box { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; background: white; display: inline-block; font-size: 10px; min-width: 70px; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .node-box.olt { border-color: var(--primary); background: #eff6ff; }
        
        .stat-val { font-weight: bold; color: var(--text); }
        .csv-btn { background: #10b981; color: white; padding: 5px 10px; border-radius: 4px; border:none; font-size: 0.75rem;}
    </style>
</head>
<body>

<!-- HEADER -->
<div class="header">
    <h2>FTTH Planner <span class="badge-sfp" id="sfpDisplay" onclick="openSettings()">SFP: 7dBm</span></h2>
</div>

<div class="container">
    
    <!-- STATS -->
    <div class="card" style="display:flex; justify-content:space-around; text-align:center;">
        <div><div class="stat-val" id="totalOdp">0</div><div style="font-size:0.7rem; color:#64748b;">ODP</div></div>
        <div><div class="stat-val" id="totalCable">0m</div><div style="font-size:0.7rem; color:#64748b;">Kabel</div></div>
        <div><div class="stat-val" id="totalLoss">0dB</div><div style="font-size:0.7rem; color:#64748b;">Max Loss</div></div>
    </div>

    <!-- TABLE -->
    <div class="card" style="padding:0; overflow:hidden;">
        <div class="card-head" style="padding:15px;">
            Struktur Jaringan
            <div>
                <button class="csv-btn" onclick="downloadCSV()">Excel</button>
                <button class="csv-btn" style="background:#6366f1" onclick="downloadImg()">Img</button>
            </div>
        </div>
        <div class="table-wrap" id="captureArea">
            <table id="mainTable">
                <thead>
                    <tr>
                        <th style="width:40px">ID</th>
                        <th>Nama Node</th>
                        <th>Jarak</th>
                        <th>Rasio</th>
                        <th>In/Out</th>
                        <th style="text-align:right">Aksi</th>
                    </tr>
                </thead>
                <tbody><!-- Data rendered here --></tbody>
            </table>
        </div>
    </div>

    <!-- TREE -->
    <div class="card">
        <div class="card-head">Visualisasi Topologi</div>
        <div class="tree-container">
            <div class="tree" id="treeRoot"></div>
        </div>
    </div>
</div>

<!-- FLOATING ACTION BUTTON -->
<button class="btn-float" onclick="openModal(0)">+</button>

<!-- MODAL INPUT -->
<div class="modal-overlay" id="modalOverlay" onclick="if(event.target===this) closeModal()">
    <div class="modal">
        <h3 style="margin-top:0; color:var(--primary)">Tambah/Edit Node</h3>
        
        <input type="hidden" id="editId" value="">
        <input type="hidden" id="parentId" value="">
        
        <div class="form-group">
            <label class="form-label">Induk (Parent)</label>
            <input type="text" id="parentNameDisplay" class="form-input" disabled style="background:#f1f5f9; color:#64748b;">
        </div>

        <div class="form-row">
            <div class="form-group" style="flex:2">
                <label class="form-label">Nama ODP</label>
                <input type="text" id="nodeName" class="form-input" placeholder="Contoh: ODP 01">
            </div>
            <div class="form-group" style="flex:1">
                <label class="form-label">Jarak (m)</label>
                <input type="number" id="nodeDist" class="form-input" value="150">
            </div>
        </div>

        <div class="form-row">
            <div class="form-group" style="flex:1">
                <label class="form-label">Jenis ODP</label>
                <select id="distSelect" class="form-select">
                    <option value="1:8">1:8 (8 Port)</option>
                    <option value="1:16">1:16 (16 Port)</option>
                    <option value="1:4">1:4 (4 Port)</option>
                    <option value="1:2">1:2 (2 Port)</option>
                    <option value="none">Splice (1 Port)</option>
                </select>
            </div>
            <div class="form-group" style="flex:1">
                <label class="form-label">Rasio</label>
                <select id="ratioSelect" class="form-select">
                    <option value="none">⛔ Direct</option>
                    <!-- Filled by JS -->
                </select>
            </div>
        </div>

        <button class="btn-block btn-save" onclick="saveNode()">Simpan</button>
        <div style="text-align:center; margin-top:15px; font-size:0.8rem; color:#ef4444; cursor:pointer;" onclick="deleteCurrentNode()" id="delBtnModal">Hapus Node Ini</div>
    </div>
</div>

<!-- MODAL SETTINGS -->
<div class="modal-overlay" id="settingOverlay" onclick="if(event.target===this) closeSettings()">
    <div class="modal">
        <h3>Pengaturan OLT</h3>
        <div class="form-group">
            <label class="form-label">Power SFP (dBm)</label>
            <input type="number" id="setSfp" class="form-input" value="7">
        </div>
        <div class="form-group">
            <label class="form-label">Loss Kabel per Km</label>
            <input type="number" id="setLossKm" class="form-input" value="0.35">
        </div>
        <div class="form-group">
            <label class="form-label">Loss Konektor</label>
            <input type="number" id="setLossConn" class="form-input" value="0.2">
        </div>
        <button class="btn-block btn-save" onclick="saveSettings()">Simpan & Hitung Ulang</button>
        <button class="btn-block" style="margin-top:10px; background:#cbd5e1" onclick="resetAll()">Reset Data</button>
    </div>
</div>

<script>
    // --- CONFIG ---
    const portLimits = { "1:2": 2, "1:4": 4, "1:8": 8, "1:16": 16, "1:32": 32, "none": 1 };
    const distLoss = { "1:2": 4.0, "1:4": 7.3, "1:8": 10.5, "1:16": 13.9, "1:32": 17.5, "none": 0 };
    let ratioLoss = { "none": {tap:0, through:0} };

    // --- STATE ---
    let appData = {
        nodes: [{ id: 0, name: "OLT", parent: null, ratio: null, distType: null, distance: 0, inputPower: 7, outputNext: 7, outputOnt: null }],
        counter: 1,
        config: { sfp: 7, lossKm: 0.35, lossConn: 0.2 }
    };

    // --- INIT ---
    function init() {
        // Init Ratios
        let rHTML = '<option value="none">⛔ Direct</option>';
        for(let i=1; i<=50; i++) {
            let tp = i, th = 100-i;
            let nm = `${tp}:${th}`;
            let tL = (-10 * Math.log10(tp/100)) + 0.8;
            let hL = (-10 * Math.log10(th/100)) + 0.8;
            ratioLoss[nm] = { tap: tL, through: hL };
            if(i%5===0 || i===1 || i===2) rHTML += `<option value="${nm}">${nm}</option>`;
        }
        document.getElementById('ratioSelect').innerHTML = rHTML;

        // Load Data
        let saved = localStorage.getItem('ftth_v9');
        if(saved) appData = JSON.parse(saved);
        
        calc();
    }

    // --- CALCULATION ---
    function calc() {
        let { sfp, lossKm, lossConn } = appData.config;
        let nodes = appData.nodes;

        nodes[0].inputPower = sfp;
        nodes[0].outputNext = sfp;
        
        // Reset
        nodes.forEach(n => { if(n.id!==0){ n.inputPower=-99; n.outputNext=-99; n.outputOnt=null; }});

        // Loop Calculation
        for(let k=0; k<15; k++) {
            nodes.forEach(n => {
                if(n.id===0) return;
                let p = nodes.find(x => x.id === n.parent);
                if(p && p.outputNext > -60) {
                    let cLoss = (n.distance/1000) * lossKm;
                    n.inputPower = p.outputNext - cLoss - lossConn;
                    
                    let dL = distLoss[n.distType] || 0;
                    if(n.ratio === 'none') {
                        // Direct
                        if(n.distType !== 'none') {
                            n.outputOnt = n.inputPower - dL - lossConn;
                            n.outputNext = n.inputPower - dL - lossConn;
                        } else {
                            n.outputOnt = null;
                            n.outputNext = n.inputPower - lossConn;
                        }
                    } else {
                        let r = ratioLoss[n.ratio] || {tap:0,through:0};
                        if(n.distType !== 'none') n.outputOnt = n.inputPower - r.tap - dL - lossConn;
                        else n.outputOnt = null;
                        n.outputNext = n.inputPower - r.through;
                    }
                }
            });
        }
        
        save();
        render();
    }

    // --- ACTIONS ---
    function openModal(parentId, editNodeId = null) {
        let pNode = appData.nodes.find(n => n.id === parentId);
        
        // Cek Limit
        if(editNodeId === null && parentId !== 0) {
            let used = appData.nodes.filter(n => n.parent === parentId).length;
            let limit = portLimits[pNode.distType] || 1;
            if(used >= limit) { alert(`Port Induk Penuh (${used}/${limit})`); return; }
            if(pNode.outputNext <= -40) { if(!confirm("Sinyal Induk Mati. Lanjut?")) return; }
        }

        document.getElementById('modalOverlay').classList.add('active');
        document.getElementById('parentId').value = parentId;
        document.getElementById('parentNameDisplay').value = pNode.name;

        if(editNodeId !== null) {
            // Edit Mode
            let n = appData.nodes.find(x => x.id === editNodeId);
            document.getElementById('editId').value = n.id;
            document.getElementById('nodeName').value = n.name;
            document.getElementById('nodeDist').value = n.distance;
            document.getElementById('distSelect').value = n.distType;
            document.getElementById('ratioSelect').value = n.ratio;
            document.getElementById('delBtnModal').style.display = 'block';
        } else {
            // New Mode
            document.getElementById('editId').value = "";
            document.getElementById('nodeName').value = "ODP " + appData.counter;
            document.getElementById('nodeDist').value = 150;
            document.getElementById('distSelect').value = "1:8";
            document.getElementById('ratioSelect').value = "none";
            document.getElementById('delBtnModal').style.display = 'none';
        }
    }

    function closeModal() { document.getElementById('modalOverlay').classList.remove('active'); }

    function saveNode() {
        let id = document.getElementById('editId').value;
        let pid = parseInt(document.getElementById('parentId').value);
        let name = document.getElementById('nodeName').value;
        let dist = parseInt(document.getElementById('nodeDist').value);
        let type = document.getElementById('distSelect').value;
        let ratio = document.getElementById('ratioSelect').value;

        if(id) {
            // Update
            let n = appData.nodes.find(x => x.id == id);
            n.name = name; n.distance = dist; n.distType = type; n.ratio = ratio;
        } else {
            // New
            appData.nodes.push({ id: appData.counter++, name, parent: pid, distance: dist, distType: type, ratio, inputPower:0, outputNext:0, outputOnt:0 });
        }
        closeModal();
        calc();
    }

    function deleteCurrentNode() {
        let id = parseInt(document.getElementById('editId').value);
        if(!id) return;
        if(confirm("Hapus node ini beserta semua cabangnya?")) {
            let ids = [id];
            for(let i=0; i<appData.nodes.length; i++) appData.nodes.forEach(n => { if(ids.includes(n.parent) && !ids.includes(n.id)) ids.push(n.id) });
            appData.nodes = appData.nodes.filter(n => !ids.includes(n.id));
            closeModal();
            calc();
        }
    }

    // --- SETTINGS ---
    function openSettings() {
        document.getElementById('settingOverlay').classList.add('active');
        document.getElementById('setSfp').value = appData.config.sfp;
    }
    function closeSettings() { document.getElementById('settingOverlay').classList.remove('active'); }
    function saveSettings() {
        appData.config.sfp = parseFloat(document.getElementById('setSfp').value);
        appData.config.lossKm = parseFloat(document.getElementById('setLossKm').value);
        appData.config.lossConn = parseFloat(document.getElementById('setLossConn').value);
        closeSettings();
        calc();
    }
    function resetAll() { if(confirm("Hapus Semua Data?")) { localStorage.removeItem('ftth_v9'); location.reload(); } }

    // --- RENDER ---
    function render() {
        document.getElementById('sfpDisplay').innerText = `SFP: ${appData.config.sfp}dBm`;
        
        let tbody = document.querySelector('#mainTable tbody');
        tbody.innerHTML = '';
        
        let totOdp=0, totCab=0, minPwr=100;

        appData.nodes.forEach(n => {
            if(n.id===0) return;
            totOdp++; totCab+=n.distance;
            if(n.outputOnt !== null && n.outputOnt < minPwr) minPwr = n.outputOnt;

            // Dot Color
            let dot = 'dot-green';
            if(n.outputOnt && n.outputOnt < -24) dot = 'dot-red';
            else if(n.outputOnt && n.outputOnt < -21) dot = 'dot-orange';
            else if(!n.outputOnt && n.outputNext < -30) dot = 'dot-red';

            // Parent Name
            let p = appData.nodes.find(x => x.id === n.parent);
            
            // Values
            let valOnt = n.outputOnt ? `${n.outputOnt.toFixed(1)}` : '-';
            let valNxt = n.outputNext > -50 ? `${n.outputNext.toFixed(1)}` : 'END';

            let row = `<tr>
                <td style="font-size:0.75rem; color:#94a3b8;">#${n.id}</td>
                <td>
                    <div style="font-weight:600;">${n.name}</div>
                    <div style="font-size:0.7rem; color:#64748b;">Induk: ${p.name}</div>
                </td>
                <td>${n.distance}m</td>
                <td>
                    <div class="badge-sfp" style="background:#e2e8f0; color:#334155;">${n.ratio==='none'?'Dir':n.ratio}</div>
                </td>
                <td style="font-size:0.8rem;">
                    <div><span class="status-dot ${dot}"></span>${valOnt}</div>
                    <div style="color:#64748b; font-size:0.7rem;">nxt: ${valNxt}</div>
                </td>
                <td style="text-align:right;">
                    <button class="btn-icon btn-add-child" onclick="openModal(${n.id})">+</button>
                    <button
